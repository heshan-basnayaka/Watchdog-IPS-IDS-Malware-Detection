<?php
$apiKey = 'fddfe91c3e9437162b816be50eaa6f7c61ffb9a070463f7300a9cef27f2ff153';
$botToken = '5929318893:AAFtMdGS6QQ_MgFlCltorumejpYel6Fji54';
$chatId = '849305317';
$uploadDirectory = 'uploads/';

if (!is_dir($uploadDirectory)) {
    mkdir($uploadDirectory);
}

if (isset($_FILES['file'])) {
    $file = $_FILES['file'];
    $fileName = $file['name'];
    $filePath = $file['tmp_name'];  // Use temporary file path for VirusTotal check

    // Check the file using the VirusTotal API
    $fileHash = hash_file("sha256", $filePath);
    $virusTotalResult = checkFileWithVirusTotal($fileHash, $apiKey);

    if ($virusTotalResult && $virusTotalResult->positives > 0) {
        // Malicious file detected, don't move the file
        $message = "Malicious file detected: $fileName\nScan results: {$virusTotalResult->positives}/{$virusTotalResult->total}";
        sendTelegramMessage($message, $botToken, $chatId);
        echo "File upload aborted. Malicious file detected.";
    } else {
        // No positives or positives property is not set, move the file
        $targetPath = $uploadDirectory . $fileName;
        if (move_uploaded_file($filePath, $targetPath)) {
            echo "File uploaded and scanned successfully.";
        } else {
            echo "File upload failed.";
        }
    }
}

function checkFileWithVirusTotal($fileHash, $apiKey) {
    $apiUrl = "https://www.virustotal.com/vtapi/v2/file/report";
    $params = array(
        "apikey" => $apiKey,
        "resource" => $fileHash
    );
    $response = file_get_contents($apiUrl . '?' . http_build_query($params));
    return json_decode($response);
}

function sendTelegramMessage($message, $botToken, $chatId) {
    $url = "https://api.telegram.org/bot$botToken/sendMessage";
    $data = array(
        'chat_id' => $chatId,
        'text' => $message,
    );

    $options = array(
        'http' => array(
            'method' => 'POST',
            'header' => 'Content-Type: application/x-www-form-urlencoded',
            'content' => http_build_query($data),
        ),
    );

    $context = stream_context_create($options);
    file_get_contents($url, false, $context);
}
?>
